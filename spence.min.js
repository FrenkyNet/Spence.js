/**
 * Spence
 *
 * An easy way to store API data offline.
 *
 * (c) 2010-2012 Frank de Jonge.
 * Spence may be freely distributed under the MIT license.
 * For all details and documentation:
 * http://spencejs.com
 */

(function(){"use strict";function o(){Error.apply(this,arguments)}var e=this,t=e._;!t&&typeof require!="undefined"&&(t=require("underscore"));var n=e.jQuery||e.Zepto||e.ender,r=e.JSON,i=e.Spence,s=function(){return Math.round(+(new Date)/1e3)};o.prototype=new Error,o.prototype.constructor=o,o.prototype.name="SpenceError",e.SpenceError=o;var u={success:function(){},error:function(){},url:!1,urlPrefix:"",storagePrefix:"Spence",storageSize:1e5,fetchStack:"FetchStack",engine:["localDatabase","localStorage"],data:null,dataType:"json",method:"GET",version:"1.0",reset:!1,expiration:!1,async:!0,crossDomain:!1,requestTimeout:0,username:null,password:null},a=function(e){this.options=t.extend({},u,e||{}),this.engine=!1,this.ensureStorageEngine()};a.noConflict=function(){return e.Spence=i,this};var f=a.Version="0.1",l=a.Engines={localStorage:function(){},localDatabase:function(){},indexedDB:function(){}},c={init:function(){var e={success:t.bind(function(e){this.fetchStack=e,this.ready()},this),error:t.bind(function(){this.fetchStack=[],this.ready()},this)};t.defaults(e,this.options),this.get(this.options.fetchStack,e)},ready:function(){},configure:function(e){return t.has(this,"options")||(this.options={}),t.extend(this.options,e),this},prefixIdentifier:function(e){return this.options.storagePrefix+e},encode:function(e,t){var n=t.expiration;return n!==!1&&(n=s()+n),r.stringify({expiration:n,payload:e,version:t.version})},decode:function(e,t){e=r.parse(e),e.expiration!==!1&&e.expiration<s()&&t.error(),e.version!==t.version&&(arguments.length<2&&this.destroy(e.version),t.error()),t.success(e.payload)},destroy:function(e){var n=this.fetchStack;return t.isUndefined(e)||(n=this.get(this.options.fetchStack,{version:e})||[]),t.each(this.fetchStack,function(e){this.remove(e)},this),this},deleteLast:function(){var e=this.fetchStack.pop();return this.remove(e)},saveFetchStack:function(){var e=t.extend({error:function(){},success:function(){throw new o("Could not save the fetchStack to local storage engine.")},expiration:!1},this.options);this.fetchStack||(this.fetchStack=[]),this.set(this.options.fetchStack,this.fetchStack,e)},getFetchStack:function(e){e||(e=function(){}),this.get(this.options.fetchStack,{success:t.bind(function(t){this.fetchStack=t,e()},this),error:t.bind(function(){this.fetchStack=[],e()},this)})}};for(var h in c)l.localStorage.prototype[h]=c[h],l.localDatabase.prototype[h]=c[h];t.extend(l.localStorage.prototype,{test:function(){return t.has(e,"localStorage")},set:function(t,n,r){var i=0,s=!1;while(i<5&&s===!1)try{e.localStorage.setItem(this.prefixIdentifier(t),this.encode(n,r.expiration)),s=!0,this.fetchStack.push(t),t!==this.options.fetchStack&&this.set(this.options.fetchStack,this.fetchStack,!1)}catch(u){var a=this.fetchStack.shift();this.remove(a)}if(!s)throw new o("Could not store value of "+t+" into".this.options.storagePrefix)},get:function(t,n){var r=e.localStorage.getItem(this.prefixIdentifier(t));if(!r)return n.error();this.decode(r,n)},remove:function(t){return e.localStorage.removeItem(t),this}}),t.extend(l.localDatabase.prototype,{test:function(){return!!e.openDatabase},init:function(){var t=this.options.storagePrefix.replace(/[^a-zA-Z 0-9]+/g,"");try{this.connection=e.openDatabase(t,"",this.options.storagePrefix,this.options.storageSize),this.connection.version!==f?this.migrate():c.init.apply(this)}catch(n){throw new o("Could establish a database connection")}},migrate:function(){this.connection.changeVersion(this.connection.version,f,t.bind(function(e){this.transaction({query:"DROP TABLE IF EXISTS "+this.options.storagePrefix,arguments:[],success:t.bind(function(){this.transaction({query:"CREATE TABLE IF NOT EXISTS "+this.options.storagePrefix+" (key VARCHAR (255) UNIQUE, payload TEXT)",arguments:[],error:t.bind(function(e){throw new o("Could not mirgate the database")},this),success:t.bind(function(){c.init.apply(this)},this)})},this),error:function(){throw new o("Count not migrate the database.")}})},this))},transaction:function(e){var n={query:null,error:function(){},success:function(){},arguments:[]};e=t.extend({},n,e);try{this.connection.transaction(function(t){t.executeSql(e.query,e.arguments,e.success,e.error)})}catch(r){e.error(r)}},get:function(e,n){var r=r=t.bind(function(e,t){t&&t.rows&&t.rows.length>0?this.decode(t.rows.item(0).payload,n):n.error()},this);this.transaction({query:"SELECT * FROM "+n.storagePrefix+" WHERE key = ?",arguments:[e],success:r,error:n.error})},set:function(e,n,r){var i=r.error;r.error=t.bind(function(t){t.code===4?this.set(e,n,r):i(t)},this),this.transaction({query:"INSERT OR REPLACE INTO "+this.options.storagePrefix+" (key, payload) VALUES (?, ?)",arguments:[e,this.encode(n,r)],error:function(){throw new o("Could not save data to local database.")},success:r.success||function(){}})}});var p={configure:function(e){return t.extend(this.options,e||{}),this.engine&&this.engine.configure(e),this},ensureStorageEngine:function(){var e=this._getValue("engine",this.options,[]),n=!1,r;t.isString(e)&&(e=[e]),t.each(e,function(e){if(!n){if(!t.has(l,e))throw new o("unknow storage engine: "+e);r=new l[e],n=r.test()}},this),n&&(this.engine=r,this.engine.configure(this.options).init())},extend:function(e){return t.defaults(e||{},this.defaults),new this.constructor(e)},_getValue:function(e,n,r){arguments.length===2&&!t.isObject(n)&&(r=n,n=null),n||(n=this.options);if(t.isUndefined(n[e])){if(!t.isUndefined(r))throw new o(" can't retrieve \""+e+'" from Spence options.');return r}return e=n[e],t.isfunction(e)?e():e},get:function(e){e||(e={}),t.defaults(e,this.options);var n=e.error;return e.error=t.bind(function(){e.error=n,this._fromApi(e)},this),this._fromLocal(e),this},set:function(e,n){if(!this.engine)throw new o("Can't inject data without a storage engine.");n||(n=this.options),t.defaults(n,this.options);var r=this._getStorageKey(n);return this.engine.set(r,e,n),this},_getStorageKey:function(e){return e.key!==!1&&!t.isUndefined(e.key)?e.key:this._getUrl(e).replace(/[^a-zA-Z 0-9]+/g,"-")},_getUrl:function(e){return t.isUndefined(e.url)||e.url===!1?!1:e.urlPrefix+this._getValue("url",e)},_fromLocal:function(e){if(!this.engine||this._getValue("reset",e,!1))alert("no engine"),e.error();else{var t=this._getStorageKey(e);this.engine.get(t,e)}},_fromApi:function(r){var i=this._getUrl(r);if(e.navigator&&e.navigator.onLine&&e.navigator.onLine!==!0||i===!1||r.api===!1){r.error();return}var s=t.bind(function(e){var t=r.success;r.success=function(){},r.error=function(e){throw new o("Can't store retrieved data to local storage engine.")};var n=this._getStorageKey(r);n!==r.fetchStack&&this.set(e,r),t(e)},this);n.ajax({type:r.method,url:r.urlPrefix+r.url,dataType:r.dataType,data:r.data,async:r.async,crossDomain:r.crossDomain,timeout:r.requestTimeout,username:this._getValue("username",r,null),password:this._getValue("password",r,null)}).done(s).fail(r.error)}};for(var d in p)a.prototype[d]=p[d];e.Spence=a}).apply(this)